name: Publish check

on:
  pull_request:
    branches:
      - master
      - main
    paths-ignore:
      - "*.md"

concurrency:
  group: publish-check-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_REPOSITORY: timescale/timescaledb-ha
  DOCKER_REGISTRY: docker.io

jobs:
  # Dry-run the most demanding build variant (pg18-all = 4 PG versions) to catch
  # disk space, build, and manifest issues before they hit the publish workflow.
  publish-check:
    name: Dry run pg18-all amd64
    runs-on: ubuntu-22.04

    steps:
      - name: remove unneeded runner software
        run: |
          df -h
          sudo rm -fr /usr/share/dotnet /usr/local/lib/android /opt/microsoft \
                      /opt/hostedtoolcache /usr/local/.ghcup /usr/local/share/boost || true
          sudo docker image prune --all --force || true
          df -h

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.ORG_DOCKER_HUB_USERNAME }}
          password: ${{ secrets.ORG_DOCKER_HUB_ACCESS_TOKEN }}

      - name: Setup | Docker Context
        run: if ! docker context use ha-builder; then docker context create ha-builder; fi

      - name: Setup | Buildx
        uses: docker/setup-buildx-action@v3
        with:
          endpoint: ha-builder

      - name: Build and push
        id: build
        env:
          PLATFORM: amd64
          PG_MAJOR: "18"
          ALL_VERSIONS: "true"
          OSS_ONLY: "false"
          DOCKER_TAG_POSTFIX: "-cicheck"
        run: make publish-builder publish-release

      - name: Validate digests for manifest compatibility
        run: |
          builder_id="${{ steps.build.outputs.builder_id }}"
          release_id="${{ steps.build.outputs.release_id }}"

          validate="$DOCKER_REGISTRY/$DOCKER_REPOSITORY:cicheck-validate"

          for digest in "$builder_id" "$release_id"; do
            echo "Validating $digest is not a manifest list..."
            docker manifest rm "$validate" 2>/dev/null || true
            docker manifest create "$validate" --amend "$DOCKER_REGISTRY/$digest"
            echo "OK: $digest is a single-platform image"
            docker manifest rm "$validate" 2>/dev/null || true
          done
